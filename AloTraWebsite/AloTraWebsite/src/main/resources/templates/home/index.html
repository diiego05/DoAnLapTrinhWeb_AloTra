<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/default_layout :: body(content=~{::content}, additionalJs=~{::additionalJs})}">
<head>
    <th:block th:fragment="additionalCss"></th:block>
</head>

<body>
<th:block th:fragment="content">
    <!-- Hero -->
    <section class="hero-section text-center d-flex align-items-center justify-content-center">
        <div class="container"></div>
    </section>

    <!-- S·∫¢N PH·∫®M B√ÅN CH·∫†Y -->
    <section class="container my-5" id="best-sellers">
        <h2 class="section-title">S·∫¢N PH·∫®M B√ÅN CH·∫†Y</h2>

        <div id="product-list-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-5 g-4">

            <!-- L·∫∑p danh s√°ch s·∫£n ph·∫©m -->
            <div class="col" th:each="product : ${bestSellers}">
                <div class="card product-card h-100 shadow-sm border-0">

                    <!-- ·∫¢nh s·∫£n ph·∫©m c√≥ th·ªÉ nh·∫•n -->
                    <a th:href="@{/product/{id}(id=${product.id})}">
                        <img th:src="@{${product.imageUrl != null ? product.imageUrl : '/images/placeholder.png'}}"
                             class="card-img-top rounded-top"
                             th:alt="${product.name}" />
                    </a>

                    <div class="card-body d-flex flex-column text-center">

                        <!-- T√™n s·∫£n ph·∫©m c√≥ th·ªÉ nh·∫•n -->
                        <h5 class="card-title mb-3">
                            <a th:href="@{/product/{id}(id=${product.id})}"
                               class="text-decoration-none text-dark fw-semibold"
                               th:text="${product.name}">T√™n s·∫£n ph·∫©m</a>
                        </h5>

                        <!-- Gi√° -->
                        <p class="price mt-auto text-success fw-bold fs-5"
                           th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
                            Gi√° s·∫£n ph·∫©m
                        </p>

                        <!-- N√∫t ƒë·∫∑t mua -->
                        <a href="#" class="btn btn-success btn-add-to-cart mt-2" th:data-product-id="${product.id}">
                            <i class="fas fa-shopping-cart me-1"></i> ƒê·∫∑t mua
                        </a>
                    </div>
                </div>
            </div>

            <!-- N·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m -->
            <div th:if="${#lists.isEmpty(bestSellers)}" class="col-12 text-center">
                <p>Ch∆∞a c√≥ s·∫£n ph·∫©m b√°n ch·∫°y n√†o.</p>
            </div>
        </div>

        <!-- Xem th√™m -->
        <div class="text-center mt-5" th:if="${#lists.size(bestSellers) > 5}">
            <th:block th:with="hiddenProductCount=${#lists.size(bestSellers) - 5}">
                <button id="view-more-btn" class="btn btn-outline-success btn-lg"
                        th:text="'Xem th√™m ' + ${hiddenProductCount} + ' s·∫£n ph·∫©m'"></button>
            </th:block>
        </div>
    </section>

    <!-- GI·ªöI THI·ªÜU -->
    <section class="container my-5 py-5 bg-light rounded shadow-sm text-center">
        <h2 class="section-title">V·ªÅ AloTra</h2>
        <p class="lead w-75 mx-auto">
            AloTra mang ƒë·∫øn nh·ªØng ly tr√† s·ªØa ch·∫•t l∆∞·ª£ng, pha ch·∫ø t·ª´ nguy√™n li·ªáu t∆∞∆°i ngon ch·ªçn l·ªçc.
            Ch√∫ng t√¥i tin r·∫±ng m·ªói ly tr√† s·ªØa kh√¥ng ch·ªâ l√† th·ª©c u·ªëng, m√† c√≤n l√† ni·ªÅm vui, l√† kho·∫£nh kh·∫Øc th∆∞ gi√£n tuy·ªát v·ªùi c·ªßa b·∫°n.
        </p>
        <a th:href="@{/about}" class="btn btn-outline-success btn-lg mt-4">T√¨m hi·ªÉu th√™m</a>
    </section>
</th:block>

<!-- JAVASCRIPT -->
<th:block th:fragment="additionalJs">
<script>
    $(document).ready(function () {
        console.log("‚úÖ Trang ch·ªß ƒë√£ s·∫µn s√†ng.");

        const productContainer = $("#product-list-container");
        const viewMoreBtn = $("#view-more-btn");

        // ·∫®n b·ªõt s·∫£n ph·∫©m n·∫øu >5
        if (productContainer.length && viewMoreBtn.length) {
            const hiddenProducts = productContainer.find(".col:gt(4)").hide();
            if (hiddenProducts.length === 0) viewMoreBtn.hide();
            viewMoreBtn.on('click', function () {
                hiddenProducts.show();
                $(this).hide();
            });
        }

        // To√†n b·ªô card (tr·ª´ n√∫t ƒê·∫∑t mua) ƒë·ªÅu c√≥ th·ªÉ nh·∫•n
        $(".product-card").on("click", function (e) {
            if (!$(e.target).closest(".btn-add-to-cart").length) {
                const link = $(this).find("a[th\\:href]").attr("href");
                if (link) window.location.href = link;
            }
        });

        // =================== üõí TH√äM GI·ªé H√ÄNG ===================
        $(document).on("click", ".btn-add-to-cart", function (e) {
            e.preventDefault();

            const token = localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken");
            if (!token) {
                showCartToast("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng.", true);
                return;
            }

            const productId = $(this).data("product-id");
            if (!productId) {
                showCartToast("‚ùå Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m.", true);
                return;
            }

            $.ajax({
                url: "/alotra-website/api/cart/items",
                type: "POST",
                contentType: "application/json",
                headers: { "Authorization": "Bearer " + token },
                data: JSON.stringify({ productId: productId, quantity: 1 }),
                success: function () {
                    showCartToast("‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!");
                    bounceCartIcon();              // üõí nh√∫n icon gi·ªè h√†ng
                    updateCartFloatingCount();     // üîÑ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                },

            });
        });

        // =================== üõí Khi nh·∫•n icon gi·ªè h√†ng ===================
        $(document).on("click", "#floating-cart .cart-btn", function (e) {
            const token = localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken");
            if (!token) {
                e.preventDefault(); // ‚ùå Kh√¥ng cho truy c·∫≠p
                showCartToast("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem gi·ªè h√†ng.", true);
            }
        });

        // =================== üîî Hi·ªÉn th·ªã th√¥ng b√°o nh·ªè b√™n c·∫°nh gi·ªè h√†ng ===================
        function showCartToast(message, isError = false) {
            const toast = $("#cart-toast");
            toast.text(message);
            toast.css("background", isError ? "#dc3545" : "#198754");
            toast.addClass("show");

            clearTimeout(toast.data("timeout")); // n·∫øu toast c≈© ch∆∞a t·∫Øt th√¨ reset
            const timeout = setTimeout(() => toast.removeClass("show"), 2000);
            toast.data("timeout", timeout);
        }

        // =================== üõí Hi·ªáu ·ª©ng rung icon gi·ªè h√†ng ===================
        function bounceCartIcon() {
            const cartBtn = $("#floating-cart .cart-btn");
            cartBtn.addClass("bounce");
            setTimeout(() => cartBtn.removeClass("bounce"), 500);
        }

        // =================== üßÆ C·∫≠p nh·∫≠t n√∫t n·ªïi gi·ªè h√†ng ===================
        function updateCartFloatingCount() {
            $.ajax({
                url: "/alotra-website/api/cart",
                type: "GET",
                headers: { "Authorization": "Bearer " + (localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken")) },
                success: function (cart) {
                    $("#cart-count").text(cart.itemsCount || 0);
                }
            });
        }

        // ‚úÖ Khi trang load l·∫ßn ƒë·∫ßu, n·∫øu ƒëƒÉng nh·∫≠p ‚Üí c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
        if (localStorage.getItem("jwtToken") || sessionStorage.getItem("jwtToken")) {
            updateCartFloatingCount();
        }
    });
</script>

</th:block>

</body>
</html>
